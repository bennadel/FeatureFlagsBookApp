
@if ( isLoading ) {

	<app-spinner></app-spinner>

}

@if ( ! isLoading && feature ) {

	<section class="temp-content">

		<h1>
			Feature: {{ feature.key }}
		</h1>

		<p>
			<a [routerLink]="[ '/features', feature.key, 'targeting' ]">Targeting</a> ,
			<a [routerLink]="[ '/features', feature.key, 'delete' ]">Delete</a> ,
			<a [routerLink]="[ '/features' ]">All Feature Flags</a> &rarr;
		</p>

		<dl>
			<div>
				<dt>Key:</dt>
				<dd>{{ feature.key }}</dd>
			</div>
			<div>
				<dt>Type:</dt>
				<dd>{{ feature.type }}</dd>
			</div>
			<div>
				<dt>Description:</dt>
				<dd>{{ feature.description }}</dd>
			</div>
			<div>
				<dt>Variants:</dt>
				<dd>
					<ol>
						@for ( variant of feature.variants ; track $index ) {
							<li>
								<span class="variant-{{ $index + 1 }}">
									{{ variant | json }}
								</span>
							</li>
						}
					</ol>
				</dd>
			</div>
		</dl>

		@for ( environment of environments ; track environment.key ) {

			@let settings = feature.targeting[ environment.key ];

			<section>

				<h2>
					{{ environment.name }}
				</h2>

				<dl>
					<div>
						<dt>
							Default Resolution:

							<a [routerLink]="[ '/features', feature.key, 'targeting', environment.key, 'default-resolution' ]">
								Edit
							</a>
						</dt>
						<dd>
							@switch ( settings.resolution.type ) {
								@case ( "selection" ) {

									<p>
										Selection
										&rarr;
										<span class="tag variant-{{ settings.resolution.selection }}">
											{{ feature.variants[ settings.resolution.selection - 1 ] | json }}
										</span>
									</p>

								}
								@case ( "distribution" ) {

									<p>
										Distribution
									</p>
									<ul class="breathing-room">
										@for ( allocation of settings.resolution.distribution ; track $index ) {

											@if ( allocation ) {

												<li>
													{{ allocation }}%
													&rarr;
													<span class="tag variant-{{ $index + 1 }}">
														{{ feature.variants[ $index ] | json }}
													</span>
												</li>

											}

										}
									</ul>

								}
								@case ( "variant" ) {

									<p>
										Variant
										&rarr;
										<span class="tag variant-0">
											{{ settings.resolution.variant | json }}
										</span>
									</p>

								}

							}
						</dd>
					</div>
					<div>
						<dt>
							<strong>Rules Enabled:</strong>

							<a [routerLink]="[ '/features', feature.key, 'targeting', environment.key, 'rules-enabled' ]">
								Edit
							</a>
						</dt>
						<dd>
							<p>
								<!-- Todo: YesNoFormat pipe? -->
								{{ settings.rulesEnabled && "Yes" || "No" }}
							</p>
						</dd>
					</div>
					<div>
						<dt>
							<strong>Rules:</strong>
						</dt>
						<dd>
							@for ( rule of settings.rules ; track $index ) {

								<dl>
									<div>
										<dt>
											<strong>IF:</strong>

											<a [routerLink]="[ '/features', feature.key, 'targeting', environment.key, 'rules', ( $index + 1 ) ]">Edit</a> ,
											<a [routerLink]="[ '/features', feature.key, 'targeting', environment.key, 'rules', ( $index + 1 ), 'delete' ]">Delete</a>
										</dt>
										<dd>
											<p>
												"{{ rule.input }}"
											</p>
										</dd>
									</div>
									<div>
										<dt>
											<strong>{{ rule.operator }}</strong>
										</dt>
										<dd>
											<p class="value-list">
												@for ( value of rule.values ; track $index ) {

													<span class="value-list__item">
														{{ value | json }}
													</span>

												}
											</p>
										</dd>
									</div>
									<div>
										<dt>
											<strong>Serve:</strong>
										</dt>
										<dd>
											@switch ( rule.resolution.type ) {
												@case ( "selection" ) {

													<p>
														Selection &rarr;
														<span class="tag variant-{{ rule.resolution.selection }}">
															{{ feature.variants[ rule.resolution.selection - 1 ] | json }}
														</span>
													</p>

												}
												@case ( "distribution" ) {

													<p>
														Distribution
													</p>
													<ul class="breathing-room">
														@for ( allocation of rule.resolution.distribution ; track $index ) {

															@if ( allocation ) {

																<li>
																	{{ allocation }}%
																	&rarr;
																	<span class="tag variant-{{ $index + 1 }}">
																		{{ feature.variants[ $index ] | json }}
																	</span>
																</li>

															}

														}
													</ul>

												}
												@case ( "variant" ) {

													<p>
														Variant
														&rarr;
														<span class="tag variant-0">
															{{ rule.resolution.variant | json }}
														</span>
													</p>

												}
											}
										</dd>
									</div>
								</dl>


								<p>
									<a [routerLink]="[ '/features', feature.key, 'targeting', environment.key, 'rules', 0 ]">Add rule</a>
								</p>

							}
						</dd>
					</div>

				</dl>

			</section>


		}

	</section>

	@if ( breakdown ) {

		<aside class="temp-map">

			<div
				class="map"
				[style.grid-template-columns]="( 'repeat(' + breakdown.environments.length + ', 1fr )' )">
				@for ( environment of breakdown.environments ; track environment.key ) {

					<div>
						{{ environment.name }}
					</div>

				}

				@for ( user of breakdown.users ; track user.id ) {

					@for ( environment of breakdown.environments ; track environment.key ) {

						@let entry = user.environments[ environment.key ];

						<a
							[routerLink]="[ '/staging/users', user.id, 'explain', feature.key, environment.key ]"
							[attr.data-association]="( environment.key + ':' + entry.ruleIndex )"
							class="variant variant-{{ entry.variantIndex }}">
						</a>

					}

				}
			</div>

		</aside>

	}

}
